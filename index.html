import React, { useState, useEffect, useCallback } from 'react';
import { Play, RotateCcw, Volume2, Trophy, Grid3X3, Languages, Settings, Check, Star } from 'lucide-react';

// --- 資料庫 Data ---
const VOCAB_DATA = {
  animals: [
    { en: 'Cat', cn: '貓' }, { en: 'Dog', cn: '狗' }, { en: 'Elephant', cn: '大象' },
    { en: 'Lion', cn: '獅子' }, { en: 'Tiger', cn: '老虎' }, { en: 'Bear', cn: '熊' },
    { en: 'Rabbit', cn: '兔子' }, { en: 'Monkey', cn: '猴子' }, { en: 'Panda', cn: '熊貓' },
    { en: 'Giraffe', cn: '長頸鹿' }, { en: 'Zebra', cn: '斑馬' }, { en: 'Horse', cn: '馬' },
    { en: 'Cow', cn: '牛' }, { en: 'Pig', cn: '豬' }, { en: 'Sheep', cn: '綿羊' },
    { en: 'Chicken', cn: '雞' }, { en: 'Duck', cn: '鴨' }, { en: 'Snake', cn: '蛇' },
    { en: 'Fish', cn: '魚' }, { en: 'Bird', cn: '鳥' }, { en: 'Turtle', cn: '烏龜' },
    { en: 'Fox', cn: '狐狸' }, { en: 'Wolf', cn: '狼' }, { en: 'Deer', cn: '鹿' },
    { en: 'Frog', cn: '青蛙' }, { en: 'Mouse', cn: '老鼠' }, { en: 'Shark', cn: '鯊魚' },
    { en: 'Whale', cn: '鯨魚' }, { en: 'Penguin', cn: '企鵝' }, { en: 'Koala', cn: '無尾熊' }
  ],
  fruits: [
    { en: 'Apple', cn: '蘋果' }, { en: 'Banana', cn: '香蕉' }, { en: 'Orange', cn: '柳橙' },
    { en: 'Grape', cn: '葡萄' }, { en: 'Lemon', cn: '檸檬' }, { en: 'Peach', cn: '桃子' },
    { en: 'Mango', cn: '芒果' }, { en: 'Pineapple', cn: '鳳梨' }, { en: 'Watermelon', cn: '西瓜' },
    { en: 'Strawberry', cn: '草莓' }, { en: 'Cherry', cn: '櫻桃' }, { en: 'Kiwi', cn: '奇異果' },
    { en: 'Melon', cn: '哈密瓜' }, { en: 'Pear', cn: '梨子' }, { en: 'Papaya', cn: '木瓜' },
    { en: 'Plum', cn: '李子' }, { en: 'Coconut', cn: '椰子' }, { en: 'Avocado', cn: '酪梨' },
    { en: 'Blueberry', cn: '藍莓' }, { en: 'Lime', cn: '萊姆' }, { en: 'Durian', cn: '榴槤' },
    { en: 'Fig', cn: '無花果' }, { en: 'Guava', cn: '芭樂' }, { en: 'Lychee', cn: '荔枝' },
    { en: 'Pomegranate', cn: '石榴' }
  ],
  colors: [
    { en: 'Red', cn: '紅色' }, { en: 'Blue', cn: '藍色' }, { en: 'Green', cn: '綠色' },
    { en: 'Yellow', cn: '黃色' }, { en: 'Orange', cn: '橘色' }, { en: 'Purple', cn: '紫色' },
    { en: 'Pink', cn: '粉紅' }, { en: 'Black', cn: '黑色' }, { en: 'White', cn: '白色' },
    { en: 'Gray', cn: '灰色' }, { en: 'Brown', cn: '棕色' }, { en: 'Gold', cn: '金色' },
    { en: 'Silver', cn: '銀色' }, { en: 'Beige', cn: '米色' }, { en: 'Navy', cn: '深藍' },
    { en: 'Teal', cn: '青色' }, { en: 'Maroon', cn: '紅褐' }, { en: 'Indigo', cn: '靛色' },
    { en: 'Cyan', cn: '青色' }, { en: 'Magenta', cn: '洋紅' }, { en: 'Olive', cn: '橄欖綠' },
    { en: 'Coral', cn: '珊瑚紅' }, { en: 'Turquoise', cn: '綠松石' }, { en: 'Lavender', cn: '薰衣草' }
  ],
  numbers: Array.from({ length: 75 }, (_, i) => ({ en: `${i + 1}`, cn: `${i + 1}` }))
};

// --- 工具函數 Helper Functions ---
const shuffleArray = (array) => {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
};

const speakText = (text) => {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);
  }
};

// --- 組件 Components ---

export default function App() {
  const [category, setCategory] = useState('animals');
  const [grid, setGrid] = useState([]);
  const [marked, setMarked] = useState(Array(25).fill(false));
  const [drawnItems, setDrawnItems] = useState([]);
  const [currentDraw, setCurrentDraw] = useState(null);
  const [bingo, setBingo] = useState(false);
  const [displayMode, setDisplayMode] = useState('both'); // 'en', 'cn', 'both'
  const [gameMode, setGameMode] = useState('solo'); // 'solo' (auto draw), 'card' (just card)

  // 初始化遊戲 Initialize Game
  const initGame = useCallback(() => {
    let items = [...VOCAB_DATA[category]];
    
    // 如果單字不夠 24 個 (扣掉中間 Free)，就重複補齊 (這在小數據庫時很有用)
    while (items.length < 24) {
      items = [...items, ...VOCAB_DATA[category]];
    }

    const shuffled = shuffleArray(items).slice(0, 24);
    
    // 插入中間的 FREE 格子
    const boardItems = [
      ...shuffled.slice(0, 12),
      { en: 'FREE', cn: '免費', isFree: true },
      ...shuffled.slice(12, 24)
    ];

    setGrid(boardItems);
    
    // 初始化標記，中間 FREE 預設已標記
    const initialMarked = Array(25).fill(false);
    initialMarked[12] = true; 
    setMarked(initialMarked);

    setDrawnItems([]);
    setCurrentDraw(null);
    setBingo(false);
  }, [category]);

  useEffect(() => {
    initGame();
  }, [initGame]);

  // 檢查勝利條件 Check Win
  useEffect(() => {
    const lines = [
      [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24], // Rows
      [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24], // Cols
      [0, 6, 12, 18, 24], [4, 8, 12, 16, 20] // Diagonals
    ];

    const isBingo = lines.some(line => line.every(index => marked[index]));
    if (isBingo && !bingo) {
      setBingo(true);
      // Play a sound or visual effect here if desired
    }
  }, [marked, bingo]);

  // 點擊格子
  const handleCellClick = (index) => {
    // 只有在非 Solo 模式，或是該格子內容已經被抽中時才能點 (嚴格模式)，
    // 但為了樂趣，我們允許玩家自由標記，或者做成"聽音辨位"
    
    const newMarked = [...marked];
    newMarked[index] = !newMarked[index];
    setMarked(newMarked);
    
    // 朗讀點擊的單字
    if (!marked[index] && !grid[index].isFree) {
       speakText(grid[index].en);
    }
  };

  // 抽牌 (莊家功能)
  const drawNext = () => {
    if (bingo) return;

    // 找出還沒被抽過的單字
    // 為了簡化，我們的"抽牌池"是整個類別的單字，而不僅僅是卡片上的
    // 這樣比較真實，因為賓果球通常比卡片格子多
    const pool = VOCAB_DATA[category].filter(item => 
      !drawnItems.some(drawn => drawn.en === item.en)
    );

    if (pool.length === 0) {
      alert("所有單字都抽完了！");
      return;
    }

    const randomItem = pool[Math.floor(Math.random() * pool.length)];
    
    setDrawnItems(prev => [randomItem, ...prev]);
    setCurrentDraw(randomItem);
    speakText(randomItem.en);
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-indigo-100">
      
      {/* 頂部導航 */}
      <header className="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-10">
        <div className="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-2">
            <Grid3X3 className="w-8 h-8 text-yellow-300" />
            <h1 className="text-2xl font-bold tracking-wider">雙語賓果 BINGO</h1>
          </div>
          
          <div className="flex flex-wrap items-center justify-center gap-3 text-sm">
             {/* 類別選擇 */}
             <div className="flex bg-indigo-700 rounded-lg p-1">
              {Object.keys(VOCAB_DATA).map(key => (
                <button
                  key={key}
                  onClick={() => setCategory(key)}
                  className={`px-3 py-1 rounded-md transition-all capitalize ${
                    category === key ? 'bg-white text-indigo-700 font-bold shadow-sm' : 'text-indigo-200 hover:text-white'
                  }`}
                >
                  {key === 'animals' ? '動物' : key === 'fruits' ? '水果' : key === 'colors' ? '顏色' : '數字'}
                </button>
              ))}
            </div>

            {/* 語言顯示模式 */}
            <button 
              onClick={() => setDisplayMode(prev => prev === 'both' ? 'en' : prev === 'en' ? 'cn' : 'both')}
              className="flex items-center gap-1 bg-indigo-500 hover:bg-indigo-400 px-3 py-1.5 rounded-full transition-colors"
              title="切換顯示語言"
            >
              <Languages size={16} />
              <span>{displayMode === 'both' ? '雙語' : displayMode === 'en' ? '英文' : '中文'}</span>
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4 md:p-6 space-y-8">
        
        {/* 控制區 & 抽牌顯示 */}
        <section className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <div className="flex flex-col md:flex-row gap-8 items-center justify-between">
            
            {/* 左側：操作按鈕 */}
            <div className="flex flex-col gap-3 w-full md:w-auto">
               <button 
                onClick={drawNext}
                disabled={bingo}
                className={`flex items-center justify-center gap-2 px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all transform active:scale-95 ${
                  bingo ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-amber-500 hover:bg-amber-400 text-white shadow-amber-200'
                }`}
              >
                <Play fill="currentColor" /> 抽下一個 (Draw)
              </button>

              <button 
                onClick={initGame}
                className="flex items-center justify-center gap-2 px-6 py-2 rounded-lg font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"
              >
                <RotateCcw size={18} /> 重新開始
              </button>
            </div>

            {/* 中間：目前抽到的單字 */}
            <div className="flex-1 w-full flex flex-col items-center">
              <div className="text-sm text-slate-400 font-medium mb-2 uppercase tracking-wide">Current Call</div>
              {currentDraw ? (
                <div className="flex flex-col items-center animate-bounce-short">
                  <span className="text-5xl md:text-6xl font-black text-indigo-600 mb-1">{currentDraw.en}</span>
                  <span className="text-2xl text-slate-500 font-medium">{currentDraw.cn}</span>
                  <button 
                    onClick={() => speakText(currentDraw.en)}
                    className="mt-2 p-2 text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors"
                  >
                    <Volume2 size={24} />
                  </button>
                </div>
              ) : (
                <div className="h-24 flex items-center justify-center text-slate-300 italic">
                  點擊「抽下一個」開始遊戲
                </div>
              )}
            </div>

            {/* 右側：歷史記錄 (最近3個) */}
            <div className="hidden md:flex flex-col gap-2 w-48 opacity-70">
              <span className="text-xs font-bold text-slate-400 uppercase">History</span>
              {drawnItems.slice(1, 4).map((item, idx) => (
                <div key={idx} className="flex justify-between items-center bg-slate-50 px-3 py-2 rounded border border-slate-100">
                  <span className="font-semibold text-slate-700">{item.en}</span>
                  <span className="text-xs text-slate-500">{item.cn}</span>
                </div>
              ))}
            </div>

          </div>
        </section>

        {/* 賓果卡片區 */}
        <section className="relative">
          {bingo && (
            <div className="absolute inset-0 z-20 flex items-center justify-center pointer-events-none">
              <div className="bg-yellow-400/90 text-yellow-900 px-12 py-6 rounded-3xl shadow-2xl transform rotate-3 animate-pulse border-4 border-white backdrop-blur-sm">
                <div className="flex items-center gap-4 text-6xl font-black">
                  <Trophy size={64} /> BINGO!
                </div>
                <p className="text-center font-bold mt-2 text-lg">恭喜你連成一線！</p>
              </div>
            </div>
          )}

          <div className="grid grid-cols-5 gap-2 md:gap-3 max-w-lg mx-auto bg-indigo-900 p-3 md:p-4 rounded-2xl shadow-xl">
            {/* Header Row (B I N G O) */}
            {['B', 'I', 'N', 'G', 'O'].map(letter => (
              <div key={letter} className="text-center text-yellow-400 font-black text-2xl md:text-3xl py-1 md:py-2">
                {letter}
              </div>
            ))}

            {/* Grid Cells */}
            {grid.map((item, index) => {
              const isMarked = marked[index];
              const isFree = item.isFree;

              return (
                <div
                  key={index}
                  onClick={() => handleCellClick(index)}
                  className={`
                    aspect-square flex flex-col items-center justify-center text-center p-1 rounded-lg cursor-pointer transition-all duration-200 relative overflow-hidden select-none
                    ${isFree 
                      ? 'bg-yellow-400 text-yellow-900 border-4 border-yellow-200' 
                      : isMarked 
                        ? 'bg-indigo-500 text-white shadow-inner scale-95 opacity-90' 
                        : 'bg-white text-slate-700 hover:bg-indigo-50 shadow-md hover:-translate-y-1'
                    }
                  `}
                >
                  {isMarked && !isFree && (
                    <div className="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
                      <div className="w-16 h-16 bg-red-500 rounded-full blur-xl"></div>
                    </div>
                  )}

                  {isMarked && (
                     <div className="absolute top-1 right-1 text-white/50">
                        <Check size={14} strokeWidth={4} />
                     </div>
                  )}

                  {isFree ? (
                    <>
                      <Star fill="currentColor" className="w-8 h-8 md:w-10 md:h-10 mb-1" />
                      <span className="text-xs font-black tracking-widest">FREE</span>
                    </>
                  ) : (
                    <>
                      {/* Primary Text */}
                      <span className={`font-bold leading-tight ${
                        item.en.length > 8 ? 'text-xs md:text-sm' : 'text-sm md:text-lg'
                      } ${(displayMode === 'cn') ? 'hidden' : 'block'}`}>
                        {item.en}
                      </span>
                      
                      {/* Secondary Text */}
                      <span className={`text-xs mt-0.5 leading-tight opacity-80 ${
                        (displayMode === 'en') ? 'hidden' : 'block'
                      }`}>
                        {item.cn}
                      </span>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </section>

        {/* 遊戲說明 */}
        <section className="text-center text-slate-400 text-sm max-w-2xl mx-auto pb-8">
          <p>遊戲規則：點擊「抽下一個」，聽到或看到單字後，在下方卡片中找到並點擊標記。連成一條線（橫、直、斜）即獲勝！</p>
        </section>
      </main>

      {/* CSS for custom bounce animation */}
      <style>{`
        @keyframes bounce-short {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
        .animate-bounce-short {
          animation: bounce-short 0.5s ease-in-out;
        }
      `}</style>
    </div>
  );
}
